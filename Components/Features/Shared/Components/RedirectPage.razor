@* RedirectPage.razor - Countdown redirect component *@
@rendermode InteractiveServer

<MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Style="min-height: 100vh; text-align: center;"
          Spacing="3" Class="pa-4">
    <MudText Typo="Typo.h4" Style="font-weight: 600;">Redirecting you shortlyâ€¦</MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary">
        You'll be automatically redirected in @_countdown second@(_countdown != 1 ? "s" : "").
    </MudText>
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium" />

    @if (_showManualLink)
    {
        <MudStack AlignItems="AlignItems.Center" Spacing="1" Class="mt-4">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                If you are not redirected automatically, please click the link below:
            </MudText>
            <MudLink Href="@TargetUrl" Underline="Underline.Hover"
                     data-umami-event='@UmamiEvent.Click("redirect-manual-link", TargetUrl)'>@TargetUrl</MudLink>
        </MudStack>
    }
</MudStack>

@code {
    [Parameter] public string TargetUrl { get; set; } = string.Empty;
    
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private int _countdown = 3;
    private bool _showManualLink;
    private Timer? _timer;

    protected override void OnInitialized()
    {
        _timer = new Timer(state => { _ = TickAsync(); }, null, 1000, 1000);

        // Show manual link after 5 seconds
        _ = ShowManualLinkAsync();
    }

    private async Task TickAsync()
    {
        _countdown--;
        if (_countdown <= 0)
        {
            _timer?.Dispose();
            await InvokeAsync(() =>
            {
                try
                {
                    Navigation.NavigateTo(TargetUrl, forceLoad: true);
                }
                catch (NavigationException)
                {
                    // Ignore framework-controlled redirect exceptions.
                }
            });
            return;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task ShowManualLinkAsync()
    {
        await Task.Delay(5000);
        _showManualLink = true;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose() => _timer?.Dispose();
}
